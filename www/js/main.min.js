var app={app_context:this,initialize:function(){this.bindEvents(),window.apiRH=(new requestHandlerAPI).construct(app),$.ajaxSetup({async:!1}),window.loggedIn=!1,app.registerCompiledPartials(),app.registerHelpers(),this.ls=window.localStorage;var e=JSON.parse(this.ls.getItem("dedalo_log_info")),a=JSON.parse(this.ls.getItem("me"));if(window.user=e?e.user_login:"",window.user_display=a?a.first_name+" "+a.last_name:window.user,window.user_first=a?a.first_name:window.user,window.user_id=e?e.user_id:"",window.user_role=e?e.user_role:"",e&&(loggedIn=!0),this.marker1=[],this.marker2=[],this.marker3=[],apiRH.has_token()){var n=apiRH.has_valid_token();if(n){$(this).data("id");console.log("You okay, now you can start making calls");var t=window.is_home;return void(t&&window.location.assign("feed.html?filter_feed=all"))}return void console.log("Your token is not valid anymore (or has not been validated yet)")}console.log("Token::: "+apiRH.request_token().get_request_token())},registerCompiledPartials:function(){console.log("Register pre compiled partials");var e=["header","history_header","history_header_nouser","search_header","feed_chunk","sidemenu","sidemenu_logged","footer","subheader","dom_assets"];e.forEach(function(e){Handlebars.registerPartial(e,Handlebars.templates[e])})},registerTemplate:function(e){$.ajax({url:"views/"+e+".hbs",success:function(a){void 0===Handlebars.templates&&(Handlebars.templates={}),Handlebars.templates[e]=Handlebars.compile(a)}})},registerHelpers:function(){Handlebars.registerHelper("if_eq",function(e,a,n){return e==a?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("if_module",function(e,a,n){return e%a==0?n.fn(this):n.inverse(this)})},bindEvents:function(){document.addEventListener("deviceready",app.onDeviceReady,!1),document.addEventListener("mobileinit",app.onDMobileInit,!1)},onBackButton:function(){var e=navigator.userAgent||navigator.vendor||window.opera;e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?history.go(-1):e.match(/Android/i)?navigator.app.backHistory():history.go(-1),console.log("BAck")},onDeviceReady:function(){app.receivedEvent("deviceready");try{OAuth.initialize("VWadBFs2rbk8esrvqSEFCyHGKnc"),console.log("Initialized Oauth")}catch(e){app.toast("Oauth error ocurred"),console.log("OAuth initialize error: "+e)}var a=document.getElementById("backBtn");a&&a.addEventListener("click",app.onBackButton,!1)},onMobileInit:function(){app.receivedEvent("mobileinit"),console.log("mobileinit")},receivedEvent:function(e){"deviceready"==e&&"undefined"!=typeof navigator.splashscreen&&navigator.splashscreen.hide()},getJsonCatalogue:function(e){var a=$.getJSON("compiled/catalogues/"+e+".json");return JSON.parse(a.responseText)},gatherEnvironment:function(e,a){var n=apiRH.ls.getItem("me"),t=apiRH.ls.getItem("me.logged"),r={me:JSON.parse(n),logged_user:JSON.parse(t)};return e&&(r.data=e),a&&(r.header_title=a),r},getUrlVars:function(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(a,n,t){e[n]=t});return e},getFormData:function(e){return $(e).serializeJSON()},isObjEmpty:function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var a in e)if(hasOwnProperty.call(e,a))return!1;return!0},render_feed:function(e,a){app.showLoader(),$.getJSON(api_base_url+"feed/"+e+"/"+a,function(e){}).fail(function(e){console.log(JSON.stringify(e)),app.hideLoader(),app.toast("Failed connecting to our servers, please check your Internet connection.")}).done(function(e){var a=app.gatherEnvironment(e);a.home_active=!0;var n=Handlebars.templates.feed;console.log(a);var t=n(a);$(".main").html(t),setTimeout(function(){app.hideLoader(),loggedIn||$("#account1").trigger("click")},2e3)})},render_search_composite:function(){user=user?user:"not_logged",$.getJSON(api_base_url+user+"/content/search-composite/").done(function(e){console.log(JSON.stringify(e)),e.search_active=!0;var a=app.gatherEnvironment(e);a.search_active=!0;var n=Handlebars.templates.search;$(".main").html(n(a))}).fail(function(e){console.log(JSON.stringify(e))})},render_search_results:function(e){$.getJSON(api_base_url+"content/search/"+e).done(function(a){console.log(a);var n=app.gatherEnvironment(a);n.search_active=!0,n.search_term=e,console.log(n);var t=Handlebars.templates.search_results;$(".main").html(t(n))}).fail(function(e){console.log(e)})},initMakersMap:function(){var e,a={zoom:15,disableDefaultUI:!0,zoomControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};setTimeout(function(){loggedIn||($(".wrapper").show(),setTimeout(function(){$("#user").animate({right:"0%"},300)},10))},2e3),e=new google.maps.Map(document.getElementById("map"),a),navigator.geolocation.getCurrentPosition(function(a){var n=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);user_first=user_first?user_first:"Guest";var t=(new google.maps.InfoWindow({map:e,position:n,content:'<div class="geoloc_me"><h3>'+user_first+"</h3></div>",buttons:{close:{visible:!1}}}),document.getElementById("allBtn"),document.getElementById("printBtn")),r=document.getElementById("scanBtn"),o=document.getElementById("shipBtn");google.maps.event.addDomListener(t,"click",function(){app.onlyprint(a,e)}),google.maps.event.addDomListener(r,"click",function(){app.onlyscan(a,e)}),google.maps.event.addDomListener(o,"click",function(){app.onlyship(a,e)}),e.setCenter(n),app.hideLoader()})},initPrinterMap:function(e){var a,n={zoom:15,disableDefaultUI:!0,zoomControl:!0,mapTypeId:google.maps.MapTypeId.ROADMAP},e=e?e:null;a=new google.maps.Map(document.getElementById("map"),n),navigator.geolocation.getCurrentPosition(function(n){var t=new google.maps.LatLng(n.coords.latitude,n.coords.longitude);new google.maps.InfoWindow({map:a,position:t,content:'<div class="geoloc_me"><h3>'+user_first+"</h3></div>",buttons:{close:{visible:!1}}});app.onlyprint(n,a,e),a.setCenter(t),app.hideLoader()})},onlyprint:function(e,a,n){app.showLoader();var t=null,r="images/marker.png",o=[];if(app.marker2.length)for(var i=0;i<app.marker2.length;i++)app.marker2[i].setMap(null);if(app.marker3.length)for(var s=0;s<app.marker3.length;s++)app.marker3[s].setMap(null);$.getJSON(api_base_url+"around/"+user+"/makers/printer?@="+e.coords.latitude+","+e.coords.longitude,function(e){}).fail(function(e){app.hideLoader(),loggedIn?app.toast("Couldn't locate printers around you, please check your GPS settings and try again."):($(".wrapper").show(),setTimeout(function(){$("#user").animate({right:"0%"},300)},10),app.toast("Please log in to locate printers and makers around you."))}).done(function(e){t=e;var i;for(i=0;i<e.count-1;i++)o.push(new google.maps.LatLng(e.pool[i].latitude,e.pool[i].longitude)),app.marker1.push(new google.maps.Marker({position:o[i],map:a,icon:r})),app.marker1[i].ref_id=parseInt(t.pool[i].ID),app.marker1[i].distance_to=t.pool[i].distance,app.marker1[i].addListener("click",function(){app.showLoader();var e=this;$.getJSON(api_base_url+"min/"+user+"/maker/"+e.ref_id).done(function(a){var t={profile:a.profile,ref_id:n,distance:e.distance_to},r=n?Handlebars.templates.maker_map_select:Handlebars.templates.maker_map;t.file_reference=n?n:null,$("#insert_info").html(r(t)),$("#info-maker").fadeIn(),app.hideLoader()}).fail(function(e){app.toast("Oops! couldn't get maker details"),app.hideLoader()})}),app.marker1[i].setVisible(!0);setTimeout(function(){app.hideLoader()},2e3),$("#info-maker").hide()})},onlyscan:function(e,a){app.showLoader();var n="images/marker.png",t=null,r=[];if(app.marker1.length)for(var o=0;o<app.marker1.length;o++)app.marker1[o].setMap(null);if(app.marker3.length)for(var i=0;i<app.marker3.length;i++)app.marker3[i].setMap(null);$.getJSON(api_base_url+"around/"+user+"/makers/scanner?@="+e.coords.latitude+","+e.coords.longitude,function(e){}).fail(function(e){console.log(JSON.stringify(e)),app.hideLoader(),app.toast("Couldn't locate scanners around you, please check your GPS settings and try again.")}).done(function(e){t=e;var o;for(o=0;o<e.count-1;o++)r.push(new google.maps.LatLng(e.pool[o].latitude,e.pool[o].longitude)),app.marker2[o].ref_id=parseInt(t.pool[o].ID),app.marker2[o].distance_to=t.pool[o].distance,app.marker2.push(new google.maps.Marker({position:r[o],map:a,icon:n})),app.marker2[o].addListener("click",function(){app.showLoader();var e=this;$.getJSON(api_base_url+"min/"+user+"/maker/"+e.ref_id).done(function(a){var n={profile:a.profile,distance:e.distance_to},t=Handlebars.templates.maker_map;$("#insert_info").html(t(n)),$("#info-maker").fadeIn(),app.hideLoader()}).fail(function(e){app.toast("Oops! couldn't get maker details"),app.hideLoader()})}),app.marker2[o].setVisible(!0);setTimeout(function(){app.hideLoader()},2e3),$("#info-maker").hide()})},onlyship:function(e,a){app.showLoader(),app.registerTemplate("partials/maker_map");var n=null,t="images/marker.png",r=[];if(app.marker1.length)for(var o=0;o<app.marker1.length;o++)app.marker1[o].setMap(null);if(app.marker2.length)for(var i=0;i<app.marker2.length;i++)app.marker2[i].setMap(null);$.getJSON(api_base_url+"around/"+user+"/makers/shipping?@="+e.coords.latitude+","+e.coords.longitude,function(e){}).fail(function(e){app.hideLoader(),app.toast("Couldn't locate printers around you, please check your GPS settings and try again.")}).done(function(e){n=e;var o;for(o=0;o<e.count-1;o++)r.push(new google.maps.LatLng(e.pool[o].latitude,e.pool[o].longitude)),app.marker3.push(new google.maps.Marker({position:r[o],map:a,icon:t})),app.marker3[o].ref_id=parseInt(n.pool[o].ID),app.marker3[o].distance_to=n.pool[o].distance,app.marker3[o].addListener("click",function(){app.showLoader();var e=this;$.getJSON(api_base_url+"min/"+user+"/maker/"+e.ref_id).done(function(a){var n={profile:a.profile,distance:e.distance_to},t=Handlebars.templates.maker_map;$("#insert_info").html(t(n)),$("#info-maker").fadeIn(),app.hideLoader()}).fail(function(e){app.toast("Oops! couldn't get maker details"),app.hideLoader()})}),app.marker3[o].setVisible(!0);setTimeout(function(){app.hideLoader()},2e3),$("#info-maker").hide()})},showall:function(){for(var e=0;e<marker1.length;e++)marker1[e].setVisible(!0);for(var e=0;e<marker2.length;e++)marker2[e].setVisible(!0);for(var e=0;e<marker3.length;e++)marker3[e].setVisible(!0);$("#info-maker").hide()},render_map:function(){var e={explore_active:!0},a=Handlebars.templates.map;$(".main").html(a(e)),app.showLoader(),app.initMakersMap()},render_file_map:function(e){var a=e,n=app.gatherEnvironment(null,"Select a printer");n.explore_active=!0;var t=Handlebars.templates.file_map;$(".main").html(t(n)),app.showLoader(),app.initPrinterMap(a)},render_detail:function(e){$.getJSON(api_base_url+"products/"+e).done(function(e){var a=app.gatherEnvironment(e,"Printables"),n=Handlebars.templates.detail;$(".main").html(n(a)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(e)})},render_post:function(e){$.getJSON(api_base_url+"content/"+e).done(function(e){var a=app.gatherEnvironment(e,"Now reading"),n=Handlebars.templates.post;$(".main").html(n(a)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(e)})},render_create_user:function(){var e=app.gatherEnvironment(null,"Create account"),a=Handlebars.templates.create_account;$(".main").html(a(e)),setTimeout(function(){app.hideLoader()},2e3)},render_settings:function(){$.getJSON(api_base_url+user+"/me/").done(function(e){var a=app.gatherEnvironment(e,"Account settings");console.log(a),a.printers=app.getJsonCatalogue("pModels");var n=Object.keys(app.getJsonCatalogue("pModels")).length,t=null;a.printer_brands=[],a.printer_models=[];for(var r=0;n>r;r++){t=Object.keys(a.printers)[r],a.printer_brands.push(t);var o=a.printers[t].length;a.printer_models[t]=[];for(var i=0;o>i;i++){var s=a.printers[t];a.printer_models[t].push(s[i])}}window.printers_global=a.printer_models;var p=Handlebars.templates.settings;$(".main").html(p(a)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(e)})},render_notifications:function(){var e=app.gatherEnvironment(null,"Notifications");e.notifications_active=!0;var a=Handlebars.templates.notifications;$(".main").html(a(e)),setTimeout(function(){app.hideLoader()},2e3)},render_dashboard:function(){$.getJSON(api_base_url+user+"/dashboard/").done(function(e){var a=app.gatherEnvironment(e,"Dashboard"),n=Handlebars.templates.dashboard;$(".main").html(n(a)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(JSON.stringify(e))})},render_maker:function(e){$.getJSON(api_base_url+user+"/maker/"+e).done(function(e){var a=app.gatherEnvironment(e,"Maker profile"),n=Handlebars.templates.maker;$(".main").html(n(a)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(e)})},render_taxonomy:function(e,a,n,t){$.getJSON(api_base_url+"content/taxonomy/"+a+"/"+e).done(function(e){console.log(e);var r="design-tools"==a?"Made with: "+e.name:e.name,o=app.gatherEnvironment(e,r),i=Handlebars.templates[t];$(n).html(i(o)),setTimeout(function(){app.hideLoader()},2e3)}).fail(function(e){console.log(e)})},render_direct_photo:function(){var e=app.gatherEnvironment(null,"Advanced search"),a=Handlebars.templates.direct_photo;$(".main").html(a(e)),setTimeout(function(){app.hideLoader()},2e3)},render_select_printer:function(e,a){var n=apiRH.makeRequest(user+"/purchase/"+e,{printer_id:a});if(n){var t=app.gatherEnvironment(null,"Printing in progress..."),r=Handlebars.templates.select_printer;return $(".main").html(r(t)),void setTimeout(function(){app.hideLoader()},2e3)}},locate_printer_here:function(){var e=function(e){var a={latitude:e.coords.latitude,longitude:e.coords.longitude},n=apiRH.makeRequest("user/"+user+"/location/",a);return console.log("response"+JSON.stringify(n)),n.success?(app.hideLoader(),void app.toast("Your current position is now registered as a printer location")):(app.hideLoader(),app.toast("Sorry, There was an error saving your location"),!1)},a=function(e){app.toast("There was a problem while getting your location, please check your GPS settings and try again.")};navigator.geolocation.getCurrentPosition(e,a,{maximumAge:3e5,timeout:1e4,enableHighAccuracy:!0})},get_file_from_device:function(e,a){apiRH.getFileFromDevice(e,a)},showLoader:function(){$("#spinner").show()},hideLoader:function(){$("#spinner").hide()},toast:function(e,a){try{a?window.plugins.toast.showLongBottom(e):window.plugins.toast.showLongCenter(e)}catch(n){console.log("Toasting error: "+JSON.stringify(n)),alert(e)}}};jQuery(document).ready(function(e){e("#register_form").length&&e("#register_form").validate({rules:{user_login_reg:"required",user_email_reg:{required:!0,email:!0},user_country:"required",i_accept_terms:"required"},messages:{user_login_reg:"Debes proporcionar un username",user_email_reg:{required:"Debes proporcionar un email",email:"Por favor proporciona un email válido"},user_country:"Por favor selecciona tu país",i_accept_terms:"Debes aceptar los términos y condiciones para continuar"},submitHandler:function(a){var n=app.getFormData("#register_form");n.user_password_reg=e("#user_password_reg").val();var t=apiRH.registerNative(n);return t?(apiRH.save_user_data_clientside(t),void window.location.assign("feed.html?filter_feed=all")):(app.toast("Lo sentimos, el nombre de usuario ya existe."),void a.preventDefault())}}),e("#logout").on("click",function(e){var a=apiRH.logOut({user_login:user,request_token:apiRH.get_request_token()});return a.success?(app.toast("Session ended, see you soon!"),app.ls.removeItem("dedalo_log_info"),app.ls.removeItem("request_token"),app.ls.removeItem("me.logged"),app.ls.removeItem("me"),void window.location.assign("feed.html")):void app.toast("Ocurrió un problema al intentar cerrar tu sesión")}),e(".main").on("tap",".each_notification a",function(a){a.preventDefault();var n=e(this).attr("href"),t=e(this);if(t.hasClass("read"))return!1;var r=t.data("id"),o=apiRH.makeRequest(user+"/notifications/read/"+r);o&&t.addClass("read"),window.location.assign(n)}),e(document).on("tap","#load_more_posts",function(a){a.preventDefault();var n=e(this).data("page");app.get_user_timeline(n),a.stopPropagation()}),e(document).on("tap","#load_more_results",function(a){a.preventDefault();var n=e(this).data("page"),t=app.getUrlVars();app.get_search_results(t.searchbox,n),a.stopPropagation()})});