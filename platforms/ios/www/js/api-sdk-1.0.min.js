function requestHandlerAPI(){this.token=null,this.upload_ready=!1,this.version="1.3",this.app_build="1.3.2",this.device_model="undefined"!=typeof device?device.model:"not set",this.device_platform="undefined"!=typeof device?device.platform:"not set",this.device_platform_version="undefined"!=typeof device?device.version:"not set",this.device_info={sdk_version:this.version,build:this.app_build,model:this.device_model,platform:this.device_platform,version:this.device_platform_version};var e=this;window.sdk_app_context=null,window.api_base_url="http://dedalo.devtdc.online/rest/v1/",this.ls=window.localStorage,this.construct=function(e){return console.log("Initialized rest API Dedalo sdk v1.2"),this.ls.getItem("request_token")&&(this.token=this.ls.getItem("request_token")),sdk_app_context=e,this},this.loginNative=function(t){var s={user_email:t.email,user_password:t.password,request_token:apiRH.get_request_token(),parts:{model:e.device_model,platform:e.device_platform,version:e.device_platform_version}},i=this.makeRequest("auth/login/",s);return console.log(i),i.success?i.data:!1},this.registerNative=function(e){var t=e.user_email;t=t.replace("@","").replace(/\./g,"").replace(/\-/g,"").replace(/\_/g,"");var s={username:t,email:e.user_email,attrs:{password:e.user_pwd,bio:e.user_bio,name:e.user_name,last_name:e.user_last_name,request_token:apiRH.get_request_token()}};console.log(s);var i=this.makeRequest("auth/user/",s);return console.log(i),i.success?i.data:!1},this.logOut=function(e){return this.makeRequest("auth/"+e.user_login+"/logout/",{request_token:e.request_token})},this.create_internal_user=function(t,s,i,o){var a,n,r,l=null;return l=this.getRequest("user/exists/",t),console.log(JSON.stringify(l)),l.success?(console.log("User already exists, saving data"),this.save_user_data_clientside(l.data),a={user_id:"none",token:apiRH.get_request_token(),validate_id:l.data.user_id?l.data.user_id:"none"},void(n=this.makeRequest("user/validateToken/",a))):(console.log("Creating new user"),a={email:s,username:t,attrs:i},console.log(JSON.stringify(a)),n=this.makeRequest("auth/user/",a),e.endHandshake(t),a={user_id:"none",token:apiRH.get_request_token(),validate_id:window.localStorage.getItem("user_id")?window.localStorage.getItem("user_id"):"none"},n=this.makeRequest("user/validateToken/",a),app.toast("User registered,\n Â¡Welcome!"),r=n.success?!0:!1)},this.save_user_data_clientside=function(e){var t=e.role;"administrator"==t&&(t="maker"),this.ls.setItem("dedalo_log_info",JSON.stringify({user_login:e.user_login,username:e.user_login,user_id:e.user_id,user_role:e.role,user_profile:e.profile_url})),$.getJSON(api_base_url+e.user_login+"/me/").done(function(e){apiRH.ls.setItem("me",JSON.stringify(e)),apiRH.ls.setItem("me.logged",!0)}).fail(function(e){console.log(e)})},this.request_token=function(){var e=this.getRequest("auth/getToken/",null);return e.success!==!1?(this.token=e.data.request_token,this.ls.setItem("request_token",e.data.request_token),this):this},this.set_user_token=function(){},this.execute=function(e,t,s){return"POST"===e?this.makeRequest(t,s):"GET"===e?this.getRequest(t,s):"PUT"===e?this.putRequest(t,s):void 0},this.has_token=function(){return"undefined"!=typeof this.token||""!==this.token?this.token:!1},this.has_valid_token=function(){if(void 0!==this.token||""!==this.token){console.log("Looks like you already have a token, let's check if it is valid");var e=void 0!=typeof this.ls.getItem("dedalo_log_info")?JSON.parse(this.ls.getItem("dedalo_log_info")):null;if(!e)return!1;var t=e.user_id,s={user_id:t,request_token:apiRH.get_request_token(),device_info:this.device_info},i=this.makeRequest("auth/user/checkToken/",s),o=i.success?!0:!1}return o},this.get_request_token=function(){return this.token},this.makeRequest=function(e,t){sdk_app_context.showLoader();var s={};return $.ajax({type:"POST",url:window.api_base_url+e,data:t,dataType:"json",async:!1}).done(function(e){s=e,sdk_app_context.hideLoader()}).fail(function(e){s=!1,console.log(JSON.stringify(e))}),s},this.getRequest=function(e,t){sdk_app_context.showLoader();var s={};return e=null===t?e:e+t,$.getJSON(window.api_base_url+e,function(e){s=e,sdk_app_context.hideLoader()}),s},this.putRequest=function(e,t){sdk_app_context.showLoader();var s={};return $.ajax({type:"PUT",data:$.param(t),contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:window.api_base_url+e}).done(function(e){s=e,sdk_app_context.hideLoader()}).fail(function(e){s=!1,console.log(e)}),s},this.patchRequest=function(e,t){sdk_app_context.showLoader();var s={},i=new XMLHttpRequest;return i.open("POST",window.api_base_url+e),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),i.onload=function(){if(console.log(i.status),200===i.status){var e=JSON.parse(i.responseText);console.log(e),sdk_app_context.hideLoader()}},i.send(t),s},this.loginOauth=function(e,t){sdk_app_context.showLoader(),OAuth.popup(e).done(t).fail(function(e){console.log(e)})},this.loginCallbackGP=function(t){t.me().done(function(t){console.log(t);var s=t.email,i=t.lastname+"_"+t.id;apiRH.create_internal_user(i,s,{gpId:t.id,avatar:t.avatar,name:t.firstname,last_name:t.lastname},window.localStorage.getItem("request_token"));e.endHandshake(i),window.location.assign("feed.html?filter_feed=all")}).fail(function(e){console.log(e)})},this.loginCallbackFB=function(t){t.me().done(function(t){console.log(t);var s=t.email,i=t.lastname+"_"+t.id;apiRH.create_internal_user(i,s,{fbId:t.id,avatar:t.avatar,name:t.firstname,last_name:t.lastname},window.localStorage.getItem("request_token"));e.endHandshake(i),window.location.assign("feed.html?filter_feed=all")}).fail(function(e){console.log(e)})},this.addImageToStack=function(e){console.log(JSON.stringify(e)),$(".close_on_touch").trigger("click");var t=Handlebars.templates.stackImage,s=t(e);$(".insert_here").append(s)},this.endHandshake=function(t){var s=e.getRequest("user/exists/"+t,null);s.success&&(data={user_id:"none",token:apiRH.get_request_token(),validate_id:s.data.user_id?s.data.user_id:"none"},response=this.makeRequest("user/validateToken/",data),e.save_user_data_clientside(s.data))},this.transfer_win=function(e){app.toast("Se ha publicado una imagen"),window.location.reload(!0)},this.profile_transfer_win=function(e){return!0},this.search_transfer_win=function(e){setTimeout(function(){app.toast("Thanks! Dedalo is processing your request."),app.registerTemplate("success_advanced_search");var t=Handlebars.templates.success_advanced_search;return console.log(JSON.parse(e.response)),$(".main").html(t(JSON.parse(e.response))),setTimeout(function(){app.hideLoader()},2e3),!0},0)},this.transfer_fail=function(e){setTimeout(function(){console.log(JSON.stringify(e)),alert("An error has occurred: Code = "+e.code),console.log("upload error source "+e.source),console.log("upload error target "+e.target)},0)},this.prepareProfileFileTransfer=function(e){app.showLoader(),this.transfer_options=new FileUploadOptions,this.transfer_options.fileUrl=e,this.transfer_options.fileKey="file",this.transfer_options.fileName=e.substr(e.lastIndexOf("/")+1),this.transfer_options.mimeType="image/jpeg",console.log(this.transfer_options);var t={};t.client="app",this.transfer_options.params=t,this.upload_ready=!0,console.log("prepareProfileTransfer"),app.hideLoader()},this.initializeProfileFileTransfer=function(){if(this.upload_ready){var t=new FileTransfer;t.upload(this.transfer_options.fileUrl,encodeURI(api_base_url+"transfers/"+user+"/profile/"),e.profile_transfer_win,e.transfer_fail,this.transfer_options)}},this.prepareSearchFileTransfer=function(e,t){app.showLoader(),console.log(e),this.transfer_options=new FileUploadOptions,this.transfer_options.fileUrl=e,this.transfer_options.fileLocal="file://"+e,this.transfer_options.fileKey="file",this.transfer_options.fileName=e.substr(e.lastIndexOf("/")+1),this.transfer_options.httpMethod="POST",this.transfer_options.mimeType="image/jpeg",this.transfer_options.quality=50,this.transfer_options.correctOrientation=!0,this.transfer_options.chunkedMode=!1,console.log(this.transfer_options);var s={};s.client="app",this.transfer_options.params=s,this.upload_ready=!0;var i={thumb:this.transfer_options.fileLocal};console.log(JSON.stringify(i)),apiRH.addImageToStack(i),console.log("prepareSearchTransfer"),app.hideLoader()},this.initializeSearchFileTransfer=function(t){if(user=user?user:"not_logged",this.upload_ready){var s=new FileTransfer;console.log(JSON.stringify(s)),this.transfer_options.params=t,s.upload(this.transfer_options.fileUrl,encodeURI(api_base_url+user+"/content/search/advanced/"),e.search_transfer_win,e.transfer_fail,this.transfer_options),app.toast("Still processing...")}},this.fileselect_win=function(t){return t||""!=t?e.prepareProfileFileTransfer(t):void 0},this.search_fileselect_win=function(t){setTimeout(function(){return console.log("r ::: "+t),console.log("Seach file sent"),t||""!=t?e.prepareSearchFileTransfer(t):void 0},0)},this.profileselect_win=function(t){return t||""!=t?void 0:e.prepareProfileFileTransfer(t)},this.fileselect_fail=function(e){app.toast("An error has occurred: "+e)},this.getFileFromDevice=function(t,s){this.photoDestinationType=navigator.camera.DestinationType;var i=navigator.camera.PictureSourceType.PHOTOLIBRARY;"camera"==s&&(i=navigator.camera.PictureSourceType.CAMERA),"profile"==t&&navigator.camera.getPicture(e.profileselect_win,e.fileselect_fail,{quality:50,destinationType:this.photoDestinationType.FILE_URI,sourceType:i,mediaType:navigator.camera.MediaType.ALLMEDIA}),"search"==t&&navigator.camera.getPicture(e.search_fileselect_win,e.fileselect_fail,{quality:100,destinationType:this.photoDestinationType.FILE_URI,sourceType:i,mediaType:navigator.camera.MediaType.ALLMEDIA})}}